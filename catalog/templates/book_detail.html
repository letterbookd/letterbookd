{% extends 'base.html' %}

{% block content %}

<!----------------------------------------------------------------------------------------------------------->
<div id="book-id" value="{{ book.pk }}"></div>

<div class="border border-3 p-3">
    <div class="d-flex">
        <div class="thumbnail">
            <img src="{{ book.thumbnail }}" style="width:auto ; height:250px"></img>
        </div>
        <div class="ms-3">
            <div class="mb-1 d-flex">
                <h2>{{ book.title }}</h2>
                <button id="personal-library-button" class="btn btn-outline-warning" data-bs-toggle="button" onclick="addBookToPersonalLibrary()">Add To Personal Library</button>
            </div>
            <div class="mb-1">
                <h4>{{ authors }}</h4>
            </div>
            <div class="mb-1">
                <label>ISBN: {{ book.isbn13 }}</label>
            </div>
            <div class="mb-1">
                <label>Category: {{ book.categories }}</label>
            </div>
            <div class="mb-1">
                <label>Publised year: {{ book.published_year }}</label>
            </div>
            <div class="mb-1">
                <label>Page count: {{ book.page_count }}</label>
            </div>
            <div class="mb-1">
                <label>Overall rating: {{ book.overall_rating }}/5</label>
            </div>
            <div class="mb-1">
                <label id="favorite-count">{{ book.favorites_count }} people added this book to their favorite.</label>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <label>Description:</label>
        <p>{{ book.description }}</p>
    </div>

    <hr>

    <div>
        <button class="btn btn-primary" onclick="showReviewsPage()">See reviews</button>
    </div>
</div>

<script>
    var book_id = document.getElementById("book-id").getAttribute("value")
    
    function showReviewsPage(){
        ;
    }

    //reload kalo teken back button di browser
    //credit: https://stackoverflow.com/questions/43043113/how-to-force-reloading-a-page-when-using-browser-back-button
    window.addEventListener("pageshow", function(event) {
        var historyTraversal = event.persisted || ( typeof window.performance != "undefined" && window.performance.navigation.type === 2 );
        if ( historyTraversal ) {
            window.location.reload();
        }
    });

    async function getFavoritedLibraryBooks(){
        return fetch("{% url 'catalog:get_favorited_library_book' '123'%}".replace('123', book_id)).then((res) => res.json())
    }

    async function handleFavoritesCount(){
        const favoritedLibraryBooks = await getFavoritedLibraryBooks()

        var favoritesCount = favoritedLibraryBooks.length
        document.getElementById("favorite-count").innerHTML = `${favoritesCount} people added this book to their favorite.`
    }

    handleFavoritesCount()

    async function addBookToPersonalLibrary(){
        let url = "{% url 'library:add_book' '123'%}".replace('123', book_id);
        await fetch(url, {method: "POST"});
    }

</script>

{% endblock content %}