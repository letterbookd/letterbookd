{% extends 'base.html' %}
{% load static %}

{% block meta %}
<style>
    #library-books .book-card:not(.card) img {
        cursor: pointer;
    }
</style>
{% endblock meta %}

{% block content %}
    <h1>Hello, {{ display_name }}!</h1>
    <p class="lead">Welcome back to your personal library</p>

    <hr>
    <div class="d-flex flex-row flex-wrap gap-2 w-auto align-items-center justify-content-center">
        <button type="button" id="sort-direction-toggle" class="btn btn-sm" aria-label="Sort direction option" data-sort-direction=1 data-bs-toggle="tooltip" data-bs-title="Toggle sort direction" data-bs-trigger="hover">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sort-down" viewBox="0 0 16 16">
                <path d="M3.5 2.5a.5.5 0 0 0-1 0v8.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L3.5 11.293V2.5zm3.5 1a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM7.5 6a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zm0 3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3zm0 3a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
            </svg>
        </button>
        <div class="form-floating pe-2 col-auto">
            <select name="sort-selection" id="sort-selection" class="form-select form-select-sm" aria-label="Sort library option">
                <option value="alphabetical" selected>Alphabetical</option>
                <option value="recent">Recently Added</option>
                <option value="tracking">Tracking Status</option>
            </select>
            <label for="sort-selection">Sort by</label>
        </div>
        <div class="form-floating pe-2">
            <select name="filter-selection" id="filter-selection" class="form-select form-select-sm" aria-label="Filter library option">
                <option value="all" selected>All</option>
                <option value="favorites">Favorites</option>
                <option value="finished">Finished Reading</option>
                <option value="reviewed">Reviewed</option>
            </select>
            <label for="filter-selection">Filter</label>
        </div>
        <div class="btn-group" role="group">
            <button id="display-grid-toggle" type="button" class="btn btn-outline-primary bg-gradient active" data-bs-toggle="tooltip" data-bs-title="Display in grid" data-bs-trigger="hover">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid-3x2" viewBox="0 0 16 16">
                    <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h13A1.5 1.5 0 0 1 16 3.5v8a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 11.5v-8zM1.5 3a.5.5 0 0 0-.5.5V7h4V3H1.5zM5 8H1v3.5a.5.5 0 0 0 .5.5H5V8zm1 0v4h4V8H6zm4-1V3H6v4h4zm1 1v4h3.5a.5.5 0 0 0 .5-.5V8h-4zm0-1h4V3.5a.5.5 0 0 0-.5-.5H11v4z"/>
                </svg>
            </button>
            <button id="display-list-toggle" type="button" class="btn btn-outline-primary bg-gradient" data-bs-toggle="tooltip" data-bs-title="Display in list" data-bs-trigger="hover">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                </svg>
            </button>
        </div>
        <button type="button" id="refresh-library" class="btn btn-sm" aria-label="Refresh library button" data-bs-toggle="tooltip" data-bs-title="Refresh library" data-bs-trigger="hover">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
              </svg>
        </button>
    </div>
    <div id="library-books" class="row row-cols-2 row-cols-lg-6 row-cols-md-6 row-cols-sm-4 g-col-6 m-4"></div>

    <!-- MODAL -->
    {% include 'library_book_modal.html' %}

{% endblock content %}

{% block scripts %}
<script>
    const url_get_library = "{% url 'library:get_library' %}";
    const url_add_book = "{% url 'library:add_book' id=12345 %}";
    const url_remove_book = "{% url 'library:remove_book' id=12345 %}";
    const url_favorite_book = "{% url 'library:favorite_book' id=12345 %}";

    var sortOption = 'alphabetical'
    var filterOption = 'all'
    var layoutOption = 'grid'
    var cachedLibrary = null;
    var sortedCachedLibrary = null;
    async function getLibrary() {
        return fetch(url_get_library).then((res) => res.json())
    }

    async function applySortAndFilters() {
        let sortedJson = JSON.parse(JSON.stringify(cachedLibrary));
        let sortDirection = sortDirectionToggle.getAttribute('data-sort-direction')
        
        if (sortOption === 'alphabetical') {
            sortedJson = sortedJson.sort(function(a,b){
                let x = a["book_data"].title.toLowerCase();
                let y = b["book_data"].title.toLowerCase();

                //compare title
                if(x>y){return sortDirection*1;} 
                if(x<y){return sortDirection*-1;}
                return 0;
            });
        } else if (sortOption === 'recent') {
            sortedJson = sortedJson.sort(function(a,b){
                let x = a["library_data"].id;
                let y = b["library_data"].id;

                //compare title
                if(x<y){return sortDirection*1;} 
                if(x>y){return sortDirection*-1;}
                return 0;
            });
        } else if (sortOption === 'tracking') {
            sortedJson = sortedJson.sort(function(a,b){
                let x = a["library_data"].tracking_status;
                let y = b["library_data"].tracking_status;

                //compare title
                if(x<y){return sortDirection*1;} 
                if(x>y){return sortDirection*-1;}
                return 0;
            });
        }

        // filtering...
        if (filterOption === 'favorites') {
            sortedJson = sortedJson.filter(obj => obj["library_data"].is_favorited == true);
        } else if (filterOption === 'finished') {
            sortedJson = sortedJson.filter(obj => obj["library_data"].tracking_status == 1);
        } else if (filterOption === 'reviewed') {
            sortedJson = sortedJson.filter(obj => obj["library_data"].is_reviewed == true);
        }
        return sortedJson
    }
    async function refreshLibraryItem(id) {
        const lib_book = (await getLibrary(id))[0]

        let htmlString = `
        ...
        \n`

        // document.querySelector("[data-item-id='" + id + "'] .card-body").innerHTML = htmlString
    }

    async function redrawLibrary() {
        let htmlString = ``;
        var counter = 0;
        
        sortedCachedLibrary.forEach((library_item) => {
            const book_data = library_item["book_data"];
            const library_data = library_item["library_data"];
            console.log(book_data)
            counter++;
            if (layoutOption == 'grid') {
                htmlString += 
                `<div class="g-col">
                    <div class="book-card p-0 d-flex flex-column justify-content-center m-0 gap-2" data-library-item-id=${library_data.id}>
                        <img src=${book_data.thumbnail} class="img-fluid rounded border border-1 shadow-sm" alt="${book_data.title} by ${book_data.authors}" data-bs-toggle="modal" data-bs-target="#detail-modal">                     
                        <span class="text-center fst-italic">${book_data.title}</span>
                    </div>
                </div>
                \n`
            } else if (layoutOption == 'list') {
                htmlString += 
                `<div class="g-col">
                    <div class="book-card card mb-3 shadow-sm bg-body-tertiary" data-library-item-id=${library_data.id}>
                        <div class="row g-0">
                            <div class="col-1 col-lg-2">
                                <img src=${book_data.thumbnail} class="h-auto img-fluid rounded-start" alt="...">
                            </div>
                            <div class="col-11 col-lg-10">
                                <div class="card-body d-flex flex-row">
                                    <div class="me-auto">
                                        <h5 class="card-title">${book_data.title}</h5>
                                        <p class="card-text">by ${book_data.authors}</p>
                                    </div>
                                    <div>
                                        <button type="button" class="btn detail-modal-trigger" data-bs-toggle="modal" data-bs-title="Open detail" data-bs-trigger="hover" data-bs-target="#detail-modal">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                                <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                \n`
            }
        })

        const library_div = document.getElementById("library-books")
        library_div.className = ""
        if (htmlString === ``) {
            htmlString = `
            <span class="fst-italic text-secondary-emphasis">Your library has no books fitting that filter :(</span>\n
            `
            library_div.classList.add("d-flex", "justify-content-center", "my-4", "mx-sm-0")
        } else {
            if (layoutOption == 'grid') {
                library_div.classList.add("row", "row-cols-2", "row-cols-lg-6", "row-cols-md-6", "row-cols-sm-4", "my-4", "mx-sm-0", "justify-content-center", "row-gap-3")
            } else {
                library_div.classList.add("row", "row-cols-lg-2", "row-cols-sm-1", "my-4", "mx-sm-0")
            }
        }
        
        library_div.innerHTML = htmlString
        await connectListeners();
        console.log('counter: ' + counter)
    }

    async function connectListeners() {
        if (layoutOption == 'grid') {
            document.querySelectorAll('#library-books img').forEach((element) => {
                element.addEventListener("click", function(e){
                    console.log(element.closest(".book-card").getAttribute("data-library-item-id"))
                })
            })
        } else if (layoutOption == 'list') {
            // connect buttons
            document.querySelectorAll('#library-books .detail-modal-trigger').forEach((element) => {
                new bootstrap.Tooltip(element);
                element.addEventListener("click", function(e){
                    console.log(element.closest(".book-card").getAttribute("data-library-item-id"))
                })
            })
        }
    }

    async function refreshLibrary() {
        cachedLibrary = (await getLibrary())["library"];
        sortedCachedLibrary = await applySortAndFilters();
        await redrawLibrary();

        // set event listeners for delete buttons
        // const deleteButtons = document.getElementsByClassName("delete-item-button")
        // for(var i = 0; i < deleteButtons.length; i++) {
        //     (function(index) {
        //         deleteButtons[index].addEventListener("click", function() {
        //             setDeleteModalId(deleteButtons[index]);
        //         })
        //     })(i);
        // }

        // // set event listeners for edit buttons
        // const editButtons = document.getElementsByClassName("edit-item-button")
        // for(var i = 0; i < editButtons.length; i++) {
        //     (function(index) {
        //         editButtons[index].addEventListener("click", function() {
        //             setEditModalId(editButtons[index]);
        //         })
        //     })(i);
        // }

        // // set event listeners for increment buttons
        // const incrButtons = document.getElementsByClassName("increment-item-button")
        // for(var i = 0; i < incrButtons.length; i++) {
        //     (function(index) {
        //         incrButtons[index].addEventListener("click", function() {
        //             incrementItem(this.closest("div.card").dataset.itemId);
        //         })
        //     })(i);
        // }

        // // set event listeners for decrement buttons
        // const decrButtons = document.getElementsByClassName("decrement-item-button")
        // for(var i = 0; i < decrButtons.length; i++) {
        //     (function(index) {
        //         decrButtons[index].addEventListener("click", function() {
        //             decrementItem(this.closest("div.card").dataset.itemId);
        //         })
        //     })(i);
        // }
    }
    refreshLibrary()

    function updateSortDirectionIcon(newDirection) {
        let svg = ``;
        if (newDirection == 1) {
            svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sort-down" viewBox="0 0 16 16">
                <path d="M3.5 2.5a.5.5 0 0 0-1 0v8.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L3.5 11.293V2.5zm3.5 1a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM7.5 6a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zm0 3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3zm0 3a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
            </svg>
            `;
        } else {
            svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sort-up" viewBox="0 0 16 16">
                <path d="M3.5 12.5a.5.5 0 0 1-1 0V3.707L1.354 4.854a.5.5 0 1 1-.708-.708l2-1.999.007-.007a.498.498 0 0 1 .7.006l2 2a.5.5 0 1 1-.707.708L3.5 3.707V12.5zm3.5-9a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM7.5 6a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zm0 3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3zm0 3a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
            </svg>
            `;
        }
        document.getElementById("sort-direction-toggle").innerHTML = svg;
    }

    // bind sort selection
    let sortSelection = document.getElementById('sort-selection')
    sortSelection.addEventListener('input', async () => {
        sortOption = sortSelection.value
        sortedCachedLibrary = await applySortAndFilters();
        redrawLibrary()
    });

    // bind filter selection
    let filterSelection = document.getElementById('filter-selection')
    filterSelection.addEventListener('input', async () => {
        filterOption = filterSelection.value
        sortedCachedLibrary = await applySortAndFilters()
        redrawLibrary()
    });

    // bind sort direction button
    let sortDirectionToggle = document.getElementById('sort-direction-toggle')
    sortDirectionToggle.addEventListener('click', async () => {
        const lastDirection = sortDirectionToggle.getAttribute('data-sort-direction')
        sortDirectionToggle.setAttribute("data-sort-direction", (lastDirection == 1 ? -1 : 1))

        sortedCachedLibrary = await applySortAndFilters()
        redrawLibrary()
        updateSortDirectionIcon(sortDirectionToggle.getAttribute('data-sort-direction'));
    })

    // bind list/grid display toggle
    let listToggle = document.getElementById('display-list-toggle')
    listToggle.addEventListener('click', async () => {
        if (layoutOption != 'list') {
            layoutOption = 'list'
            redrawLibrary();
            updateGridToggleIcon();
            updateListToggleIcon();
        }
    })
    let gridToggle = document.getElementById('display-grid-toggle')
    gridToggle.addEventListener('click', async () => {
        if (layoutOption != 'grid') {
            layoutOption = 'grid'
            redrawLibrary()
            updateGridToggleIcon();
            updateListToggleIcon();
        }
    })

    function updateGridToggleIcon() {
        let svg = ``;
        if (layoutOption == 'grid') {
            gridToggle.classList.add("active");
            svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid-3x2-gap-fill" viewBox="0 0 16 16">
                <path d="M1 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V4zM1 9a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V9zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V9z"/>
            </svg>
            `;
        } else {
            gridToggle.classList.remove("active");
            svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid-3x2" viewBox="0 0 16 16">
                <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h13A1.5 1.5 0 0 1 16 3.5v8a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 11.5v-8zM1.5 3a.5.5 0 0 0-.5.5V7h4V3H1.5zM5 8H1v3.5a.5.5 0 0 0 .5.5H5V8zm1 0v4h4V8H6zm4-1V3H6v4h4zm1 1v4h3.5a.5.5 0 0 0 .5-.5V8h-4zm0-1h4V3.5a.5.5 0 0 0-.5-.5H11v4z"/>
            </svg>
            `;
        }
        gridToggle.innerHTML = svg;
    }
    function updateListToggleIcon() {
        if (layoutOption == 'list') {
            listToggle.classList.add("active");
        } else {
            listToggle.classList.remove("active");
        }
    }
    updateGridToggleIcon();

    // refresh library button
    document.getElementById('refresh-library').addEventListener('click', refreshLibrary)

    // tooltips
    let tooltipelements = document.querySelectorAll("[data-bs-toggle='tooltip']");
    tooltipelements.forEach((el) => {
        new bootstrap.Tooltip(el);
    });
</script>
<!-- <script type="text/javascript" src="{% static '/library/js/library_handler.js' %}"></script> -->
{% endblock scripts %}